// Firebase Security Rules for StudentHub
// Copy these rules to your Firebase Console > Firestore Database > Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isCampusEmail() {
      return isAuthenticated() &&
             request.auth.token.email.matches('.*@.*\\.edu.*');
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Users collection
    match /users/{userId} {
      // Allow read/write for authenticated users to their own document
      allow read, write: if isOwner(userId) && isCampusEmail();

      // Allow create for new users with campus email
      allow create: if isCampusEmail() &&
                       request.auth.uid == userId &&
                       request.resource.data.role in ['student', 'merchant'];
    }

    // Tuckshop items collection
    match /tuckshopItems/{itemId} {
      // Allow read for all authenticated campus users
      allow read: if isAuthenticated() && isCampusEmail();

      // Allow write only for merchants
      allow write: if isAuthenticated() &&
                      isCampusEmail() &&
                      getUserRole() == 'merchant' &&
                      request.auth.uid == resource.data.merchantId;
    }

    // Orders collection
    match /orders/{orderId} {
      // Allow read/write for order owner (student)
      allow read, write: if isAuthenticated() &&
                            isCampusEmail() &&
                            request.auth.uid == resource.data.userId;

      // Allow merchants to read orders for their items
      allow read: if isAuthenticated() &&
                     isCampusEmail() &&
                     getUserRole() == 'merchant' &&
                     exists(/databases/$(database)/documents/tuckshopItems/$(resource.data.items[0].id)) &&
                     get(/databases/$(database)/documents/tuckshopItems/$(resource.data.items[0].id)).data.merchantId == request.auth.uid;

      // Allow merchants to update order status
      allow update: if isAuthenticated() &&
                       isCampusEmail() &&
                       getUserRole() == 'merchant' &&
                       request.resource.data.diff(resource.data).affectedKeys() == ['status'].toSet();
    }

    // Marketplace items collection
    match /marketplaceItems/{itemId} {
      // Allow read for all authenticated campus users
      allow read: if isAuthenticated() && isCampusEmail();

      // Allow write for authenticated campus users (students posting items)
      allow write: if isAuthenticated() &&
                      isCampusEmail() &&
                      request.auth.uid == resource.data.sellerId;
    }

    // Messages collection
    match /messages/{messageId} {
      // Allow read/write only between conversation participants
      allow read, write: if isAuthenticated() &&
                            isCampusEmail() &&
                            (request.auth.uid == resource.data.senderId ||
                             request.auth.uid == resource.data.receiverId);
    }

    // Conversations collection
    match /conversations/{conversationId} {
      // Allow read/write only for conversation participants
      allow read, write: if isAuthenticated() &&
                            isCampusEmail() &&
                            request.auth.uid in resource.data.participants;
    }
  }
}

// Firebase Storage Rules
// Copy these rules to Firebase Console > Storage > Rules

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /marketplace/{userId}/{allPaths=**} {
      // Allow read for all authenticated campus users
      allow read: if request.auth != null &&
                     request.auth.token.email.matches('.*@.*\\.edu.*');

      // Allow write only for the authenticated user
      allow write: if request.auth != null &&
                      request.auth.token.email.matches('.*@.*\\.edu.*') &&
                      request.auth.uid == userId;
    }

    match /tuckshop/{merchantId}/{allPaths=**} {
      // Allow read for all authenticated campus users
      allow read: if request.auth != null &&
                     request.auth.token.email.matches('.*@.*\\.edu.*');

      // Allow write only for merchants
      allow write: if request.auth != null &&
                      request.auth.token.email.matches('.*@.*\\.edu.*') &&
                      getUserRole() == 'merchant' &&
                      request.auth.uid == merchantId;
    }
  }
}
